<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Integration Demo with Metrics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1c1e21;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #1877f2;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .description {
            color: #65676b;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #dddfe2;
        }
        .card-title {
            font-size: 1.3rem;
            color: #1877f2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .card-title i {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        .btn {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn i {
            margin-right: 8px;
        }
        .btn:hover {
            background-color: #166fe5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn:disabled {
            background-color: #e4e6eb;
            color: #bcc0c4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-logout {
            background-color: #f02849;
        }
        .btn-logout:hover {
            background-color: #d62d4d;
        }
        .hidden {
            display: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
        }
        .status.info {
            background-color: #e7f3ff;
            color: #1877f2;
            border: 1px solid #1877f2;
        }
        .status.success {
            background-color: #e7f3ff;
            color: #1877f2;
            border: 1px solid #1877f2;
        }
        .status.error {
            background-color: #ffe7e7;
            color: #f02849;
            border: 1px solid #f02849;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1c1e21;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1877f2;
            box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f2f5;
            border-radius: 8px;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: #1877f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        .user-details {
            flex-grow: 1;
        }
        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .user-id {
            color: #65676b;
            font-size: 0.9rem;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #65676b;
            font-size: 0.9rem;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dddfe2;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom: 3px solid #1877f2;
            color: #1877f2;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .post {
            border: 1px solid #dddfe2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
        }
        .post-message {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .post-date {
            color: #65676b;
            font-size: 0.9rem;
        }
        .post-media {
            margin-top: 10px;
        }
        .post-media img, .post-media video {
            max-width: 100%;
            border-radius: 8px;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .two-column, .three-column {
                grid-template-columns: 1fr;
            }
        }
        .instructions {
            background-color: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-bottom: 10px;
            color: #1877f2;
        }
        .instructions ol {
            margin-left: 20px;
        }
        .instructions li {
            margin-bottom: 10px;
        }
        .media-upload {
            margin: 20px 0;
            border: 2px dashed #dddfe2;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .media-upload:hover {
            border-color: #1877f2;
        }
        .media-upload i {
            font-size: 2rem;
            color: #1877f2;
            margin-bottom: 10px;
        }
        .media-preview {
            margin-top: 20px;
            text-align: center;
        }
        .media-preview img, .media-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
        }
        .page-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .page-item {
            border: 1px solid #dddfe2;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-item:hover {
            border-color: #1877f2;
            transform: translateY(-2px);
        }
        .page-item.selected {
            border-color: #1877f2;
            background-color: #e7f3ff;
        }
        .page-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .page-category {
            color: #65676b;
            font-size: 0.9rem;
        }
        .warning {
            background-color: #fff4e6;
            border-left: 4px solid #ffa94d;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .warning-title {
            color: #e67700;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .metrics-card {
            background: #f7f8fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .metrics-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1877f2;
            margin: 10px 0;
        }
        .metrics-label {
            color: #65676b;
            font-size: 0.9rem;
        }
        .metrics-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        .positive {
            color: #42b883;
        }
        .negative {
            color: #f02849;
        }
        .comments-section {
            margin-top: 15px;
            border-top: 1px solid #dddfe2;
            padding-top: 15px;
        }
        .comment {
            padding: 10px;
            border-bottom: 1px solid #dddfe2;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #4267b2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .comment-author {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .comment-date {
            color: #65676b;
            font-size: 0.8rem;
            margin-left: auto;
        }
        .comment-message {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .comment-likes {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #65676b;
        }
        .comment-likes i {
            margin-right: 5px;
            color: #f02849;
        }
        .post-metrics {
            display: flex;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dddfe2;
        }
        .post-metric {
            display: flex;
            align-items: center;
            margin-right: 15px;
            font-size: 0.9rem;
            color: #65676b;
        }
        .post-metric i {
            margin-right: 5px;
        }
        .likes-metric i {
            color: #1877f2;
        }
        .comments-metric i {
            color: #42b883;
        }
        .shares-metric i {
            color: #ffa500;
        }
        .chart-container {
            height: 200px;
            margin-top: 15px;
            position: relative;
        }
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 30px;
            background-color: #1877f2;
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease;
        }
        .chart-labels {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .chart-label {
            font-size: 0.8rem;
            color: #65676b;
            text-align: center;
            width: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #dddfe2;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f2f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Facebook Integration Demo with Metrics</h1>
            <p class="description">Connect with Facebook to manage your pages, post content, and view metrics</p>
        </header>
       
        <div class="warning">
            <div class="warning-title">Important Setup Instructions:</div>
            <p>For this demo to work properly, you must:</p>
            <ol>
                <li>Create a Facebook App at <a href="https://developers.facebook.com/" target="_blank">Facebook Developers</a></li>
                <li>Add "https://localhost" to your App Domains in Facebook App Settings</li>
                <li>Add "https://localhost" as a Valid OAuth Redirect URI</li>
                <li>Run this page on a local server (not as a file)</li>
            </ol>
        </div>
       
        <div class="instructions">
            <h3>How to Use This Demo:</h3>
            <ol>
                <li>Enter your Facebook App ID and click "Submit App ID".</li>
                <li>Click "Connect Facebook" to authenticate with OAuth.</li>
                <li>After login, select a page to manage.</li>
                <li>Create a post with text, images, or videos and publish it.</li>
                <li>View your page's posts and metrics in the "View Posts" tab.</li>
                <li>Check page insights in the "Metrics" tab.</li>
                <li>View ad campaigns and insights in the "Ad Campaigns" tab.</li>
            </ol>
            <p><strong>Note:</strong> This demo uses localhost for development. For production, you'll need to use a real domain with HTTPS.</p>
        </div>
       
        <div class="tabs">
            <div class="tab active" data-tab="connect">Connect</div>
            <div class="tab" data-tab="post">Create Post</div>
            <div class="tab" data-tab="posts">View Posts</div>
            <div class="tab" data-tab="metrics">Metrics</div>
            <div class="tab" data-tab="ads">Ad Campaigns</div>
        </div>
       
        <div class="tab-content active" id="connect-tab">
            <div class="card">
                <h2 class="card-title"><i class="fab fa-facebook"></i> Facebook Connection</h2>
                <div id="appIdForm">
                    <div class="form-group">
                        <label for="appIdInput">Facebook App ID:</label>
                        <input type="text" id="appIdInput" placeholder="Enter your Facebook App ID">
                    </div>
                    <button id="submitAppIdBtn" class="btn">
                        <i class="fas fa-check"></i> Submit App ID
                    </button>
                </div>
                <div id="userInfo" class="user-info hidden">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">User Name</div>
                        <div class="user-id" id="userIdDisplay">User ID: </div>
                    </div>
                    <button id="logoutBtn" class="btn btn-logout">Logout</button>
                </div>
                <button id="connectBtn" class="btn hidden">
                    <i class="fab fa-facebook"></i> Connect Facebook
                </button>
                <div id="status" class="status info hidden">
                    <span id="statusText"></span>
                </div>
                <div id="pageSelection" class="hidden">
                    <h3>Select a Page to Manage:</h3>
                    <div id="pageList" class="page-list"></div>
                </div>
                <div id="adAccountSelection" class="hidden">
                    <h3>Select an Ad Account:</h3>
                    <div id="adAccountList" class="page-list"></div>
                </div>
            </div>
        </div>
       
        <div class="tab-content" id="post-tab">
            <div class="two-column">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-edit"></i> Create Post</h2>
                    <div class="form-group">
                        <label for="pageSelect">Selected Page:</label>
                        <select id="pageSelect" disabled>
                            <option value="">-- Select a Page --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="postContent">Post Content:</label>
                        <textarea id="postContent" placeholder="What would you like to post?"></textarea>
                    </div>
                    <div class="media-upload" id="mediaUpload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload image or video</p>
                        <input type="file" id="mediaFile" accept="image/*,video/*" hidden>
                    </div>
                    <div id="mediaPreview" class="media-preview hidden"></div>
                    <button id="postBtn" class="btn" disabled>
                        <i class="fas fa-paper-plane"></i> Publish Post
                    </button>
                    <div id="postStatus" class="status info hidden">
                        <span id="postStatusText"></span>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-image"></i> Post Preview</h2>
                    <div id="postPreview">
                        <div class="post">
                            <div class="user-info">
                                <div class="user-avatar" id="previewAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-details">
                                    <div class="user-name" id="previewPageName">Page Name</div>
                                    <div class="post-date">Just now</div>
                                </div>
                            </div>
                            <div class="post-message" id="previewContent">Your post content will appear here...</div>
                            <div id="previewMedia" class="post-media"></div>
                            <div class="post-metrics">
                                <div class="post-metric likes-metric">
                                    <i class="fas fa-thumbs-up"></i> 0 likes
                                </div>
                                <div class="post-metric comments-metric">
                                    <i class="fas fa-comment"></i> 0 comments
                                </div>
                                <div class="post-metric shares-metric">
                                    <i class="fas fa-share"></i> 0 shares
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
       
        <div class="tab-content" id="posts-tab">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-history"></i> Your Posts</h2>
                <div class="form-group">
                    <label for="retrievePageSelect">Selected Page:</label>
                    <select id="retrievePageSelect" disabled>
                        <option value="">-- Select a Page --</option>
                    </select>
                </div>
                <button id="retrieveBtn" class="btn">
                    <i class="fas fa-sync-alt"></i> Load Posts
                </button>
                <div id="postsContainer">
                    <h3 style="margin: 20px 0 10px;">Recent Posts</h3>
                    <div id="postsList">
                        <p class="description">Your posts will appear here after you load them</p>
                    </div>
                </div>
                <div id="retrieveStatus" class="status info hidden">
                    <span id="retrieveStatusText"></span>
                </div>
            </div>
        </div>
       
        <div class="tab-content" id="metrics-tab">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Page Metrics</h2>
                <div class="form-group">
                    <label for="metricsPageSelect">Selected Page:</label>
                    <select id="metricsPageSelect" disabled>
                        <option value="">-- Select a Page --</option>
                    </select>
                </div>
                <button id="loadMetricsBtn" class="btn">
                    <i class="fas fa-chart-bar"></i> Load Metrics
                </button>
               
                <div id="metricsContainer" class="hidden">
                    <h3 style="margin: 20px 0 10px;">Page Insights</h3>
                   
                    <div class="three-column">
                        <div class="metrics-card">
                            <i class="fas fa-users fa-2x"></i>
                            <div class="metrics-value" id="followersCount">0</div>
                            <div class="metrics-label">Total Followers</div>
                            <div class="metrics-change positive" id="followersChange">+0% from last week</div>
                        </div>
                       
                        <div class="metrics-card">
                            <i class="fas fa-eye fa-2x"></i>
                            <div class="metrics-value" id="reachCount">0</div>
                            <div class="metrics-label">Post Reach</div>
                            <div class="metrics-change positive" id="reachChange">+0% from last week</div>
                        </div>
                       
                        <div class="metrics-card">
                            <i class="fas fa-user-check fa-2x"></i>
                            <div class="metrics-value" id="engagementCount">0</div>
                            <div class="metrics-label">Engagement Rate</div>
                            <div class="metrics-change positive" id="engagementChange">+0% from last week</div>
                        </div>
                    </div>
                   
                    <div class="chart-container" id="metricsChart">
                        <div class="chart-labels">
                            <div class="chart-label">Mon</div>
                            <div class="chart-label">Tue</div>
                            <div class="chart-label">Wed</div>
                            <div class="chart-label">Thu</div>
                            <div class="chart-label">Fri</div>
                            <div class="chart-label">Sat</div>
                            <div class="chart-label">Sun</div>
                        </div>
                    </div>
                   
                    <h3 style="margin: 30px 0 15px;">Top Performing Posts</h3>
                    <div id="topPostsList">
                        <p class="description">Top posts will appear here</p>
                    </div>
                </div>
               
                <div id="metricsStatus" class="status info hidden">
                    <span id="metricsStatusText"></span>
                </div>
            </div>
        </div>

        <div class="tab-content" id="ads-tab">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-ad"></i> Ad Campaigns</h2>
                <div class="form-group">
                    <label for="adsAccountSelect">Selected Ad Account:</label>
                    <select id="adsAccountSelect" disabled>
                        <option value="">-- Select an Ad Account --</option>
                    </select>
                </div>
                <button id="loadCampaignsBtn" class="btn">
                    <i class="fas fa-sync-alt"></i> Load Campaigns
                </button>
                <div id="campaignsContainer">
                    <h3 style="margin: 20px 0 10px;">Campaigns</h3>
                    <div id="campaignsList">
                        <p class="description">Your campaigns will appear here after you load them</p>
                    </div>
                </div>
                <div id="adsStatus" class="status info hidden">
                    <span id="adsStatusText"></span>
                </div>
            </div>
        </div>
       
        <div class="footer">
            <p>This is a demonstration of Facebook integration with OAuth authentication and metrics.</p>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const appIdForm = document.getElementById('appIdForm');
            const appIdInput = document.getElementById('appIdInput');
            const submitAppIdBtn = document.getElementById('submitAppIdBtn');
            const connectBtn = document.getElementById('connectBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userIdDisplay = document.getElementById('userIdDisplay');
            const pageSelect = document.getElementById('pageSelect');
            const retrievePageSelect = document.getElementById('retrievePageSelect');
            const metricsPageSelect = document.getElementById('metricsPageSelect');
            const adsAccountSelect = document.getElementById('adsAccountSelect');
            const postContent = document.getElementById('postContent');
            const postBtn = document.getElementById('postBtn');
            const postStatus = document.getElementById('postStatus');
            const postStatusText = document.getElementById('postStatusText');
            const retrieveBtn = document.getElementById('retrieveBtn');
            const retrieveStatus = document.getElementById('retrieveStatus');
            const retrieveStatusText = document.getElementById('retrieveStatusText');
            const postsList = document.getElementById('postsList');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const previewContent = document.getElementById('previewContent');
            const previewPageName = document.getElementById('previewPageName');
            const previewMedia = document.getElementById('previewMedia');
            const mediaUpload = document.getElementById('mediaUpload');
            const mediaFile = document.getElementById('mediaFile');
            const mediaPreview = document.getElementById('mediaPreview');
            const pageSelection = document.getElementById('pageSelection');
            const pageList = document.getElementById('pageList');
            const adAccountSelection = document.getElementById('adAccountSelection');
            const adAccountList = document.getElementById('adAccountList');
            const loadMetricsBtn = document.getElementById('loadMetricsBtn');
            const metricsContainer = document.getElementById('metricsContainer');
            const metricsStatus = document.getElementById('metricsStatus');
            const metricsStatusText = document.getElementById('metricsStatusText');
            const followersCount = document.getElementById('followersCount');
            const followersChange = document.getElementById('followersChange');
            const reachCount = document.getElementById('reachCount');
            const reachChange = document.getElementById('reachChange');
            const engagementCount = document.getElementById('engagementCount');
            const engagementChange = document.getElementById('engagementChange');
            const metricsChart = document.getElementById('metricsChart');
            const topPostsList = document.getElementById('topPostsList');
            const loadCampaignsBtn = document.getElementById('loadCampaignsBtn');
            const campaignsList = document.getElementById('campaignsList');
            const adsStatus = document.getElementById('adsStatus');
            const adsStatusText = document.getElementById('adsStatusText');
           
            // State
            let userData = null;
            let pages = [];
            let adAccounts = [];
            let postsData = [];
            let currentPage = null;
            let currentAdAccount = null;
            let selectedMedia = null;
            let accessToken = '';
            let APP_ID = '';
           
            // Configuration - Using localhost for development
            const REDIRECT_URI = window.location.origin;
            const FB_API_VERSION = 'v19.0';
           
            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
           
            // Event Listeners
            submitAppIdBtn.addEventListener('click', submitAppId);
            connectBtn.addEventListener('click', startOAuthFlow);
            logoutBtn.addEventListener('click', logout);
            postBtn.addEventListener('click', createPost);
            retrieveBtn.addEventListener('click', retrievePosts);
            postContent.addEventListener('input', updatePostPreview);
            mediaUpload.addEventListener('click', () => mediaFile.click());
            mediaFile.addEventListener('change', handleMediaUpload);
            loadMetricsBtn.addEventListener('click', loadMetrics);
            loadCampaignsBtn.addEventListener('click', loadCampaigns);
           
            // Check for OAuth response in URL
            checkOAuthResponse();
           
            function submitAppId() {
                APP_ID = appIdInput.value.trim();
                if (!APP_ID || !/^\d+$/.test(APP_ID)) {
                    showStatus('Please enter a valid Facebook App ID (numeric only)', 'error');
                    return;
                }
                appIdForm.classList.add('hidden');
                connectBtn.classList.remove('hidden');
                showStatus('App ID submitted. Click "Connect Facebook" to authenticate.', 'success');
            }
           
            function checkOAuthResponse() {
                const urlParams = new URLSearchParams(window.location.hash.substr(1));
                const token = urlParams.get('access_token');
                const error = urlParams.get('error_description');
               
                if (error) {
                    showStatus('Authentication failed: ' + decodeURIComponent(error), 'error');
                    appIdForm.classList.remove('hidden');
                    connectBtn.classList.add('hidden');
                    return;
                }
               
                if (token) {
                    accessToken = token;
                    showStatus('Successfully authenticated! Fetching user data...', 'info');
                    getUserData();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
           
            function startOAuthFlow() {
                if (!APP_ID) {
                    showStatus('Please submit a valid App ID first', 'error');
                    return;
                }
               
                showStatus('Redirecting to Facebook for authentication...', 'info');
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading"></span> Connecting...';
               
                const authUrl = `https://www.facebook.com/${FB_API_VERSION}/dialog/oauth?client_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=pages_show_list,pages_read_engagement,pages_manage_posts,read_insights,ads_read&response_type=token`;
                window.location.href = authUrl;
            }
           
            function getUserData() {
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/me?fields=id,name,email,picture&access_token=${accessToken}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch user data: ${response.statusText}`);
                        return response.json();
                    })
                    .then(user => {
                        userData = user;
                        userName.textContent = userData.name;
                        userIdDisplay.textContent = `User ID: ${userData.id}`;
                       
                        if (userData.picture && userData.picture.data.url) {
                            userAvatar.innerHTML = `<img src="${userData.picture.data.url}" alt="User Avatar" style="width: 100%; height: 100%; border-radius: 50%;">`;
                        }
                       
                        userInfo.classList.remove('hidden');
                        appIdForm.classList.add('hidden');
                        connectBtn.classList.add('hidden');
                        getPages();
                        getAdAccounts();
                    })
                    .catch(error => {
                        showStatus('Error fetching user data: ' + error.message, 'error');
                        appIdForm.classList.remove('hidden');
                        connectBtn.classList.add('hidden');
                        connectBtn.disabled = false;
                        connectBtn.innerHTML = '<i class="fab fa-facebook"></i> Connect Facebook';
                    });
            }
           
            function getPages() {
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/me/accounts?access_token=${accessToken}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch pages: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        pages = response.data;
                       
                        if (pages.length === 0) {
                            showStatus('No pages found for this account. Please ensure you have admin access to at least one page.', 'error');
                            return;
                        }
                       
                        showPagesSelection();
                        showStatus('Authentication complete! Select a page and ad account to manage.', 'success');
                    })
                    .catch(error => {
                        showStatus('Error fetching pages: ' + error.message, 'error');
                        appIdForm.classList.remove('hidden');
                        connectBtn.classList.add('hidden');
                    });
            }
           
            function getAdAccounts() {
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/me/adaccounts?access_token=${accessToken}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch ad accounts: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        adAccounts = response.data;
                       
                        if (adAccounts.length > 0) {
                            showAdAccountsSelection();
                        }
                    })
                    .catch(error => {
                        showStatus('Error fetching ad accounts: ' + error.message, 'error');
                    });
            }
           
            function showPagesSelection() {
                pageSelection.classList.remove('hidden');
                pageList.innerHTML = '';
               
                pages.forEach(page => {
                    const pageItem = document.createElement('div');
                    pageItem.className = 'page-item';
                    pageItem.innerHTML = `
                        <div class="page-name">${page.name}</div>
                        <div class="page-category">${page.category}</div>
                    `;
                   
                    pageItem.addEventListener('click', () => {
                        document.querySelectorAll('#pageList .page-item').forEach(item => item.classList.remove('selected'));
                        pageItem.classList.add('selected');
                        selectPage(page);
                    });
                   
                    pageList.appendChild(pageItem);
                });
            }

            function showAdAccountsSelection() {
                adAccountSelection.classList.remove('hidden');
                adAccountList.innerHTML = '';
               
                adAccounts.forEach(adAccount => {
                    const adItem = document.createElement('div');
                    adItem.className = 'page-item';
                    adItem.innerHTML = `
                        <div class="page-name">${adAccount.name}</div>
                        <div class="page-category">ID: ${adAccount.account_id}</div>
                    `;
                   
                    adItem.addEventListener('click', () => {
                        document.querySelectorAll('#adAccountList .page-item').forEach(item => item.classList.remove('selected'));
                        adItem.classList.add('selected');
                        selectAdAccount(adAccount);
                    });
                   
                    adAccountList.appendChild(adItem);
                });
            }
           
            function selectPage(page) {
                currentPage = page;
                pageSelect.innerHTML = `<option value="${page.id}" selected>${page.name} (${page.category})</option>`;
                retrievePageSelect.innerHTML = `<option value="${page.id}" selected>${page.name} (${page.category})</option>`;
                metricsPageSelect.innerHTML = `<option value="${page.id}" selected>${page.name} (${page.category})</option>`;
                pageSelect.disabled = false;
                retrievePageSelect.disabled = false;
                metricsPageSelect.disabled = false;
                postBtn.disabled = !postContent.value.trim() && !selectedMedia;
               
                // Update preview with page name
                previewPageName.textContent = page.name;
               
                document.querySelector('[data-tab="post"]').click();
            }

            function selectAdAccount(adAccount) {
                currentAdAccount = adAccount;
                adsAccountSelect.innerHTML = `<option value="${adAccount.id}" selected>${adAccount.name}</option>`;
                adsAccountSelect.disabled = false;
            }
           
            function handleMediaUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
               
                selectedMedia = file;
                mediaPreview.classList.remove('hidden');
                mediaPreview.innerHTML = '';
               
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    mediaPreview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = true;
                    mediaPreview.appendChild(video);
                }
               
                updatePostPreview();
            }
           
            function updatePostPreview() {
                const content = postContent.value.trim();
                previewContent.textContent = content || 'Your post content will appear here...';
               
                if (currentPage) {
                    previewPageName.textContent = currentPage.name;
                }
               
                previewMedia.innerHTML = '';
               
                if (selectedMedia) {
                    if (selectedMedia.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(selectedMedia);
                        img.style.maxWidth = '100%';
                        previewMedia.appendChild(img);
                    } else if (selectedMedia.type.startsWith('video/')) {
                        const video = document.createElement('video');
                        video.src = URL.createObjectURL(selectedMedia);
                        video.controls = true;
                        video.style.maxWidth = '100%';
                        previewMedia.appendChild(video);
                    }
                }
               
                postBtn.disabled = !content && !selectedMedia;
            }
           
            function createPost() {
                if (!currentPage) {
                    showPostStatus('Please select a page first', 'error');
                    return;
                }
               
                const content = postContent.value.trim();
                if (!content && !selectedMedia) {
                    showPostStatus('Please enter content or upload media', 'error');
                    return;
                }
               
                showPostStatus('Publishing post to Facebook...', 'info');
                postBtn.disabled = true;
                postBtn.innerHTML = '<span class="loading"></span> Publishing...';
               
                const formData = new FormData();
                if (content) {
                    formData.append('message', content);
                }
                formData.append('access_token', currentPage.access_token);
               
                let url = `https://graph.facebook.com/${FB_API_VERSION}/${currentPage.id}/feed`;
               
                if (selectedMedia) {
                    if (selectedMedia.type.startsWith('image/')) {
                        url = `https://graph.facebook.com/${FB_API_VERSION}/${currentPage.id}/photos`;
                        formData.append('source', selectedMedia);
                    } else if (selectedMedia.type.startsWith('video/')) {
                        url = `https://graph.facebook.com/${FB_API_VERSION}/${currentPage.id}/videos`;
                        formData.append('filedata', selectedMedia);
                    }
                }
               
                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to post: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        if (response.error) {
                            throw new Error(response.error.message);
                        }
                       
                        showPostStatus('Successfully posted to your page!', 'success');
                        postContent.value = '';
                        selectedMedia = null;
                        mediaPreview.classList.add('hidden');
                        mediaPreview.innerHTML = '';
                        mediaFile.value = '';
                        previewMedia.innerHTML = '';
                        previewContent.textContent = 'Your post content will appear here...';
                        postBtn.disabled = false;
                        postBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish Post';
                    })
                    .catch(error => {
                        showPostStatus('Error posting: ' + error.message, 'error');
                        postBtn.disabled = false;
                        postBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish Post';
                    });
            }
           
            function retrievePosts() {
                if (!currentPage) {
                    showRetrieveStatus('Please select a page first', 'error');
                    return;
                }
               
                showRetrieveStatus('Loading posts from Facebook...', 'info');
                retrieveBtn.disabled = true;
                retrieveBtn.innerHTML = '<span class="loading"></span> Loading...';
               
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/${currentPage.id}/feed?fields=id,message,created_time,attachments{type,media{image{src},source}},likes.summary(true),comments.summary(true).limit(5){from{name},message,created_time,likes.summary(true)},shares&access_token=${currentPage.access_token}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch posts: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        postsData = response.data;
                        displayPosts(postsData);
                        showRetrieveStatus(`Loaded ${postsData.length} posts`, 'success');
                        retrieveBtn.disabled = false;
                        retrieveBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Load Posts';
                    })
                    .catch(error => {
                        showRetrieveStatus('Error loading posts: ' + error.message, 'error');
                        retrieveBtn.disabled = false;
                        retrieveBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Load Posts';
                    });
            }
           
            function displayPosts(posts) {
                postsList.innerHTML = '';
               
                if (posts.length === 0) {
                    postsList.innerHTML = '<p class="description">No posts found for this page</p>';
                    return;
                }
               
                // Sort posts by date (newest first)
                posts.sort((a, b) => new Date(b.created_time) - new Date(a.created_time));
               
                posts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'post';
                   
                    const message = document.createElement('div');
                    message.className = 'post-message';
                    message.textContent = post.message || '(No text content)';
                   
                    const date = document.createElement('div');
                    date.className = 'post-date';
                    date.textContent = new Date(post.created_time).toLocaleString();
                   
                    const mediaContainer = document.createElement('div');
                    mediaContainer.className = 'post-media';
                   
                    if (post.attachments && post.attachments.data) {
                        post.attachments.data.forEach(attachment => {
                            if (attachment.media) {
                                if (attachment.type.includes('video')) {
                                    const video = document.createElement('video');
                                    video.src = attachment.media.source;
                                    video.controls = true;
                                    mediaContainer.appendChild(video);
                                } else {
                                    const img = document.createElement('img');
                                    img.src = attachment.media.image.src;
                                    mediaContainer.appendChild(img);
                                }
                            }
                        });
                    }
                   
                    // Add metrics section
                    const metricsContainer = document.createElement('div');
                    metricsContainer.className = 'post-metrics';
                   
                    const likesCount = post.likes && post.likes.summary ? post.likes.summary.total_count : 0;
                    const commentsCount = post.comments && post.comments.summary ? post.comments.summary.total_count : 0;
                    const sharesCount = post.shares && post.shares.count ? post.shares.count : 0;
                   
                    metricsContainer.innerHTML = `
                        <div class="post-metric likes-metric">
                            <i class="fas fa-thumbs-up"></i> ${likesCount} likes
                        </div>
                        <div class="post-metric comments-metric">
                            <i class="fas fa-comment"></i> ${commentsCount} comments
                        </div>
                        <div class="post-metric shares-metric">
                            <i class="fas fa-share"></i> ${sharesCount} shares
                        </div>
                    `;
                   
                    // Add comments section
                    const commentsSection = document.createElement('div');
                    commentsSection.className = 'comments-section';
                   
                    if (post.comments && post.comments.data && post.comments.data.length > 0) {
                        const commentsTitle = document.createElement('h4');
                        commentsTitle.textContent = 'Recent Comments:';
                        commentsSection.appendChild(commentsTitle);
                       
                        post.comments.data.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment';
                           
                            const header = document.createElement('div');
                            header.className = 'comment-header';
                           
                            const avatar = document.createElement('div');
                            avatar.className = 'comment-avatar';
                            const authorName = comment.from.name || 'Anonymous';
                            avatar.textContent = authorName.charAt(0).toUpperCase();
                           
                            const author = document.createElement('div');
                            author.className = 'comment-author';
                            author.textContent = authorName;
                           
                            const commentDate = document.createElement('div');
                            commentDate.className = 'comment-date';
                            commentDate.textContent = new Date(comment.created_time).toLocaleString();
                           
                            header.appendChild(avatar);
                            header.appendChild(author);
                            header.appendChild(commentDate);
                           
                            const commentMessage = document.createElement('div');
                            commentMessage.className = 'comment-message';
                            commentMessage.textContent = comment.message;
                           
                            const commentLikes = document.createElement('div');
                            commentLikes.className = 'comment-likes';
                            const commentLikesCount = comment.likes && comment.likes.summary ? comment.likes.summary.total_count : 0;
                            commentLikes.innerHTML = `<i class="fas fa-heart"></i> ${commentLikesCount} likes`;
                           
                            commentEl.appendChild(header);
                            commentEl.appendChild(commentMessage);
                            commentEl.appendChild(commentLikes);
                           
                            commentsSection.appendChild(commentEl);
                        });
                    }
                   
                    postEl.appendChild(message);
                    postEl.appendChild(date);
                   
                    if (mediaContainer.children.length > 0) {
                        postEl.appendChild(mediaContainer);
                    }
                   
                    postEl.appendChild(metricsContainer);
                   
                    if (commentsCount > 0) {
                        postEl.appendChild(commentsSection);
                    }
                   
                    postsList.appendChild(postEl);
                });
            }
           
            function loadMetrics() {
                if (!currentPage) {
                    showMetricsStatus('Please select a page first', 'error');
                    return;
                }
               
                showMetricsStatus('Loading page metrics...', 'info');
                loadMetricsBtn.disabled = true;
                loadMetricsBtn.innerHTML = '<span class="loading"></span> Loading...';
               
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/${currentPage.id}/insights?metric=page_fans,page_impressions,page_post_engagements&period=day&date_preset=last_14d&access_token=${currentPage.access_token}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch metrics: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        if (response.error) throw new Error(response.error.message);

                        const data = response.data || [];
                        if (data.length === 0) {
                            throw new Error('No metrics data available for this page');
                        }

                        // Extract metrics data
                        const fans = data.find(m => m.name === 'page_fans')?.values || [];
                        const impressions = data.find(m => m.name === 'page_impressions')?.values || [];
                        const engagements = data.find(m => m.name === 'page_post_engagements')?.values || [];

                        if (!fans.length || !impressions.length || !engagements.length) {
                            throw new Error('Incomplete metrics data received');
                        }

                        const num_days = impressions.length;
                        if (num_days < 7) {
                            throw new Error('Insufficient data for the last 14 days');
                        }

                        const half = Math.floor(num_days / 2);

                        // Calculate followers
                        const curr_followers = fans[num_days - 1]?.value || 0;
                        const prev_followers = fans[half - 1]?.value || 0;
                        const followers_change = prev_followers > 0 ? ((curr_followers - prev_followers) / prev_followers * 100).toFixed(1) : 0;
                        const change_sign_f = followers_change >= 0 ? '+' : '';
                        const class_f = followers_change >= 0 ? 'positive' : 'negative';

                        // Calculate reach (impressions)
                        let prev_impressions = 0;
                        for (let i = 0; i < half; i++) prev_impressions += impressions[i]?.value || 0;
                        let curr_impressions = 0;
                        for (let i = half; i < num_days; i++) curr_impressions += impressions[i]?.value || 0;
                        const reach_change = prev_impressions > 0 ? ((curr_impressions - prev_impressions) / prev_impressions * 100).toFixed(1) : 0;
                        const change_sign_r = reach_change >= 0 ? '+' : '';
                        const class_r = reach_change >= 0 ? 'positive' : 'negative';

                        // Calculate engagement rate
                        let prev_engagements = 0;
                        for (let i = 0; i < half; i++) prev_engagements += engagements[i]?.value || 0;
                        let curr_engagements = 0;
                        for (let i = half; i < num_days; i++) curr_engagements += engagements[i]?.value || 0;
                        const curr_rate = curr_impressions > 0 ? (curr_engagements / curr_impressions * 100).toFixed(1) : 0;
                        const prev_rate = prev_impressions > 0 ? (prev_engagements / prev_impressions * 100).toFixed(1) : 0;
                        const engagement_change = prev_rate > 0 ? ((curr_rate - prev_rate) / prev_rate * 100).toFixed(1) : 0;
                        const change_sign_e = engagement_change >= 0 ? '+' : '';
                        const class_e = engagement_change >= 0 ? 'positive' : 'negative';

                        // Update DOM elements
                        followersCount.textContent = curr_followers.toLocaleString();
                        followersChange.textContent = `${change_sign_f}${followers_change}% from last week`;
                        followersChange.className = `metrics-change ${class_f}`;

                        reachCount.textContent = curr_impressions.toLocaleString();
                        reachChange.textContent = `${change_sign_r}${reach_change}% from last week`;
                        reachChange.className = `metrics-change ${class_r}`;

                        engagementCount.textContent = `${curr_rate}%`;
                        engagementChange.textContent = `${change_sign_e}${engagement_change}% from last week`;
                        engagementChange.className = `metrics-change ${class_e}`;

                        // Generate chart data for the last 7 days
                        const chart_data = impressions.slice(-7).map(v => v.value || 0);
                        generateChartData(chart_data);

                        // Generate top posts
                        generateTopPosts();

                        metricsContainer.classList.remove('hidden');
                        showMetricsStatus('Metrics loaded successfully', 'success');
                        loadMetricsBtn.disabled = false;
                        loadMetricsBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Load Metrics';
                    })
                    .catch(error => {
                        showMetricsStatus('Error loading metrics: ' + error.message, 'error');
                        loadMetricsBtn.disabled = false;
                        loadMetricsBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Load Metrics';
                    });
            }
           
            function generateChartData(chart_data) {
                const chartBars = metricsChart.querySelectorAll('.chart-bar');
                chartBars.forEach(bar => bar.remove());
               
                const max_value = Math.max(...chart_data, 1); // avoid division by zero
                const max_height = 180;
               
                chart_data.forEach((value, index) => {
                    const height = (value / max_value) * max_height;
                   
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = `${height}px`;
                    bar.style.left = `${(index * 45) + 10}px`;
                   
                    metricsChart.appendChild(bar);
                });
            }
           
            function generateTopPosts() {
                // Clear existing top posts
                topPostsList.innerHTML = '';
               
                if (postsData.length === 0) {
                    topPostsList.innerHTML = '<p class="description">No posts available to analyze</p>';
                    return;
                }
               
                // Sort posts by engagement (likes + comments + shares)
                const sortedPosts = [...postsData].sort((a, b) => {
                    const aLikes = a.likes && a.likes.summary ? a.likes.summary.total_count : 0;
                    const aComments = a.comments && a.comments.summary ? a.comments.summary.total_count : 0;
                    const aShares = a.shares && a.shares.count ? a.shares.count : 0;
                    const aEngagement = aLikes + aComments + aShares;
                   
                    const bLikes = b.likes && b.likes.summary ? b.likes.summary.total_count : 0;
                    const bComments = b.comments && b.comments.summary ? b.comments.summary.total_count : 0;
                    const bShares = b.shares && b.shares.count ? b.shares.count : 0;
                    const bEngagement = bLikes + bComments + bShares;
                   
                    return bEngagement - aEngagement;
                });
               
                // Show top 3 posts
                const topPosts = sortedPosts.slice(0, 3);
               
                topPosts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'post';
                   
                    const message = document.createElement('div');
                    message.className = 'post-message';
                    message.textContent = post.message ? (post.message.length > 100 ? post.message.substring(0, 100) + '...' : post.message) : '(No text content)';
                   
                    const date = document.createElement('div');
                    date.className = 'post-date';
                    date.textContent = new Date(post.created_time).toLocaleString();
                   
                    const likesCount = post.likes && post.likes.summary ? post.likes.summary.total_count : 0;
                    const commentsCount = post.comments && post.comments.summary ? post.comments.summary.total_count : 0;
                    const sharesCount = post.shares && post.shares.count ? post.shares.count : 0;
                    const totalEngagement = likesCount + commentsCount + sharesCount;
                   
                    const metricsContainer = document.createElement('div');
                    metricsContainer.className = 'post-metrics';
                    metricsContainer.innerHTML = `
                        <div class="post-metric likes-metric">
                            <i class="fas fa-thumbs-up"></i> ${likesCount}
                        </div>
                        <div class="post-metric comments-metric">
                            <i class="fas fa-comment"></i> ${commentsCount}
                        </div>
                        <div class="post-metric shares-metric">
                            <i class="fas fa-share"></i> ${sharesCount}
                        </div>
                        <div style="margin-left: auto; font-weight: bold;">
                            Total: ${totalEngagement}
                        </div>
                    `;
                   
                    postEl.appendChild(message);
                    postEl.appendChild(date);
                    postEl.appendChild(metricsContainer);
                   
                    topPostsList.appendChild(postEl);
                });
            }

            function loadCampaigns() {
                if (!currentAdAccount) {
                    showAdsStatus('Please select an ad account first', 'error');
                    return;
                }
               
                showAdsStatus('Loading campaigns...', 'info');
                loadCampaignsBtn.disabled = true;
                loadCampaignsBtn.innerHTML = '<span class="loading"></span> Loading...';
               
                fetch(`https://graph.facebook.com/${FB_API_VERSION}/${currentAdAccount.id}/campaigns?fields=name,status,objective&access_token=${accessToken}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch campaigns: ${response.statusText}`);
                        return response.json();
                    })
                    .then(response => {
                        const campaigns = response.data;
                        displayCampaigns(campaigns);
                        showAdsStatus(`Loaded ${campaigns.length} campaigns`, 'success');
                        loadCampaignsBtn.disabled = false;
                        loadCampaignsBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Load Campaigns';
                    })
                    .catch(error => {
                        showAdsStatus('Error loading campaigns: ' + error.message, 'error');
                        loadCampaignsBtn.disabled = false;
                        loadCampaignsBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Load Campaigns';
                    });
            }

            function displayCampaigns(campaigns) {
                campaignsList.innerHTML = '';
               
                if (campaigns.length === 0) {
                    campaignsList.innerHTML = '<p class="description">No campaigns found for this ad account</p>';
                    return;
                }
               
                campaigns.forEach(camp => {
                    const campEl = document.createElement('div');
                    campEl.className = 'post';
                   
                    const name = document.createElement('div');
                    name.className = 'post-message';
                    name.textContent = camp.name;
                   
                    const details = document.createElement('div');
                    details.className = 'post-date';
                    details.textContent = `Status: ${camp.status}, Objective: ${camp.objective}`;
                   
                    const insightsBtn = document.createElement('button');
                    insightsBtn.className = 'btn';
                    insightsBtn.textContent = 'Load Insights';
                    insightsBtn.addEventListener('click', () => loadCampaignInsights(camp.id));
                   
                    const insightsDiv = document.createElement('div');
                    insightsDiv.id = `insights-${camp.id}`;
                   
                    campEl.appendChild(name);
                    campEl.appendChild(details);
                    campEl.appendChild(insightsBtn);
                    campEl.appendChild(insightsDiv);
                   
                    campaignsList.appendChild(campEl);
                });
            }

            function loadCampaignInsights(campaignId) {
                const insightsDiv = document.getElementById(`insights-${campaignId}`);
                insightsDiv.innerHTML = '<span class="loading"></span> Loading insights...';
            
                // Ensure the ad account and campaign exist
                if (!currentAdAccount || !campaignId) {
                    insightsDiv.innerHTML = '<p class="description">Error: No ad account or campaign selected</p>';
                    showAdsStatus('Please select an ad account and campaign', 'error');
                    return;
                }
                // Ensure access token is valid
                if (!accessToken) {
                    insightsDiv.innerHTML = '<p class="description">Error: No valid access token available</p>';
                    showAdsStatus('Authentication error: Please reconnect to Facebook', 'error');
                    return;
                }
            
                // Fetch campaign insights with breakdowns by age and country
                const url = `https://graph.facebook.com/${FB_API_VERSION}/${campaignId}/insights?fields=reach,impressions,spend&breakdowns=age,country&date_preset=last_30d&access_token=${accessToken}`;
                console.log('Fetching insights with URL:', url); // Debugging log
        
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                    throw new Error(`Failed to fetch insights: ${response.statusText} (Status: ${response.status}, Code: ${errorData.error?.code || 'Unknown'}, Message: ${errorData.error?.message || 'No details provided'})`);
                                });
                            }
                            return response.json();
                    })
                    .then(response => {
                        if (response.error) {
                            throw new Error(`API Error: ${response.error.message} (Code: ${response.error.code})`);
                        }
            
                        const data = response.data || [];
                        if (data.length === 0) {
                            insightsDiv.innerHTML = '<p class="description">No insights data available for this campaign</p>';
                            showAdsStatus('No insights data available for this campaign', 'info');
                            return;
                        }
            
                        // Process insights data
                        let table = '<table><thead><tr><th>Age</th><th>Country</th><th>Reach</th><th>Impressions</th><th>Spend</th></tr></thead><tbody>';
                        data.forEach(row => {
                            table += `<tr>
                                <td>${row.age || 'N/A'}</td>
                                <td>${row.country || 'N/A'}</td>
                                <td>${row.reach ? parseInt(row.reach).toLocaleString() : 0}</td>
                                <td>${row.impressions ? parseInt(row.impressions).toLocaleString() : 0}</td>
                                <td>${row.spend ? parseFloat(row.spend).toFixed(2) : 0}</td>
                            </tr>`;
                        });
                        table += '</tbody></table>';
            
                        insightsDiv.innerHTML = table;
                        showAdsStatus('Campaign insights loaded successfully', 'success');
                    })
                    .catch(error => {
                        insightsDiv.innerHTML = `<p class="description">Error loading insights: ${error.message}</p>`;
                        showAdsStatus(`Error loading campaign insights: ${error.message}`, 'error');
                        console.error('Insights Fetch Error:', error);
                    });
            }
           
            function logout() {
                userData = null;
                pages = [];
                adAccounts = [];
                postsData = [];
                currentPage = null;
                currentAdAccount = null;
                selectedMedia = null;
                accessToken = '';
                APP_ID = '';
               
                userInfo.classList.add('hidden');
                appIdForm.classList.remove('hidden');
                connectBtn.classList.add('hidden');
                pageSelection.classList.add('hidden');
                adAccountSelection.classList.add('hidden');
                postContent.value = '';
                mediaPreview.classList.add('hidden');
                mediaPreview.innerHTML = '';
                mediaFile.value = '';
                previewMedia.innerHTML = '';
                postsList.innerHTML = '<p class="description">Your posts will appear here after you load them</p>';
                campaignsList.innerHTML = '<p class="description">Your campaigns will appear here after you load them</p>';
                appIdInput.value = '';
                metricsContainer.classList.add('hidden');
               
                showStatus('Logged out successfully', 'info');
                document.querySelector('[data-tab="connect"]').click();
            }
           
            function showStatus(message, type) {
                statusText.textContent = message;
                status.className = `status ${type}`;
                status.classList.remove('hidden');
            }
           
            function showPostStatus(message, type) {
                postStatusText.textContent = message;
                postStatus.className = `status ${type}`;
                postStatus.classList.remove('hidden');
            }
           
            function showRetrieveStatus(message, type) {
                retrieveStatusText.textContent = message;
                retrieveStatus.className = `status ${type}`;
                retrieveStatus.classList.remove('hidden');
            }
           
            function showMetricsStatus(message, type) {
                metricsStatusText.textContent = message;
                metricsStatus.className = `status ${type}`;
                metricsStatus.classList.remove('hidden');
            }

            function showAdsStatus(message, type) {
                adsStatusText.textContent = message;
                adsStatus.className = `status ${type}`;
                adsStatus.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
